# List All Restaurants (Raw SQL)
query ListAllRestaurants @auth(level: PUBLIC, insecureReason: "This query is safe to expose to the public") {
  _select(sql: "SELECT id, name, owner_uid, active, metadata, tags FROM restaurant")
}

# Basic Select All (GraphQL Fields)
query SelectAll @auth(level: PUBLIC, insecureReason: "This operation is safe to expose to the public") {
  restaurants {
    id
    name
    ownerUid
    active
    metadata
    tags
  }
}

# Select with Aliases
query SelectAliases @auth(level: PUBLIC, insecureReason: "This operation is safe to expose to the public") {
  _select(sql: "SELECT name AS restaurant_name, active AS is_open FROM restaurant")
}

# Select Distinct
query SelectDistinct @auth(level: NO_ACCESS) {
  _select(sql: "SELECT DISTINCT id FROM review")
}

# Case Statements
query CaseStatement @auth(level: NO_ACCESS) {
  _select(sql: "SELECT name, CASE WHEN active THEN 'OPEN' ELSE 'CLOSED' END as status FROM restaurant")
}

# Where Clause with Operators & Params
query WhereOperators($namePattern: String!, $minRating: Float!) @auth(level: NO_ACCESS) {
  _select(
    sql: "SELECT * FROM restaurant r JOIN review v ON r.id = v.id WHERE r.name LIKE $1 AND v.rating >= $2",
    params: [$namePattern, $minRating]
  )
}

# Where with Subquery
query Subquery @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM restaurant WHERE id IN (SELECT id FROM review WHERE rating = 5.0)")
}

# Null Parameter Handling
query NullParam($content: String) @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM review WHERE content IS NULL OR content = $1", params: [$content])
}

# Inner Join
query InnerJoin @auth(level: NO_ACCESS) {
  _select(sql: "SELECT r.name, v.content FROM restaurant r INNER JOIN review v ON r.id = v.id")
}

# Complex Ordering
query ComplexOrder @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM review ORDER BY rating DESC, visit_date ASC NULLS LAST")
}

# Window Functions (Rank)
query WindowFunction @auth(level: NO_ACCESS) {
  _select(sql: "SELECT id, rating, RANK() OVER (PARTITION BY id ORDER BY rating DESC) as rank FROM review")
}

# Type Casting
query TypeCast @auth(level: NO_ACCESS) {
  _select(sql: "SELECT id::TEXT as id_str, rating::INTEGER as rating_int FROM review")
}

# Date Functions
query DateMath @auth(level: NO_ACCESS) {
  _select(sql: "SELECT visit_date, visit_date + INTERVAL '7 days' as next_week FROM review")
}

# Zero Rows
query ZeroRows @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM restaurant WHERE name LIKE '%Cuppa%'")
}

# Scalar Params
query ScalarParams(
  $active: Boolean!
  $id: Int!
  $rating: Float!
  $name: String!
) @auth(level: PUBLIC) {
  _select(
    sql: "SELECT * FROM restaurant WHERE active = $1 AND id = $2 AND name = $4",
    params: [$active, $id, $rating, $name]
  )
}

# Array Params (SQL IN)
query ArrayParams($ids: [Int!]) @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM restaurant WHERE id = ANY($1)", params: [$ids])
}

# Unused Param and Invalid Select
query UnusedParamAndInvalidSelect($id: Int!) @auth(level: PUBLIC) {
  _select(sql: "SELECT hakjdsh", params: [$id])
}

# Invalid Select (DDL)
query InvalidSelect {
  _select(sql: "CREATE TABLE bad (id INT)")
}

# ------------------------------------------------------------------------------
# SINGLE RESULT QUERIES
# ------------------------------------------------------------------------------

# Select One Row
query SelectOne($id: Int) @auth(level: NO_ACCESS) {
  _selectFirst(sql: "SELECT * FROM restaurant WHERE id = $1", params: [$id])
}

# Select First of Many
query SelectFirstOfMany @auth(level: NO_ACCESS) {
  _selectFirst(sql: "SELECT * FROM restaurant ORDER BY id ASC")
}

# Select First Null
query SelectFirstNull @auth(level: NO_ACCESS) {
  _selectFirst(sql: "SELECT * FROM restaurant WHERE id = -999")
}

# Aggregates
query Aggregates @auth(level: NO_ACCESS) {
  _selectFirst(sql: "SELECT COUNT(*) as total, AVG(rating) as average FROM review")
}

# CTE
query CTE @auth(level: NO_ACCESS) {
  _selectFirst(sql: "WITH TopReviews AS (SELECT restaurant_id FROM review WHERE rating=5) SELECT * FROM restaurant WHERE id IN (SELECT * FROM TopReviews) LIMIT 1")
}

# JSON Result Structure
query JsonStructure @auth(level: NO_ACCESS) {
  _selectFirst(sql: "SELECT metadata FROM restaurant WHERE metadata IS NOT NULL LIMIT 1")
}

# ------------------------------------------------------------------------------
# ERROR & SECURITY SCENARIOS
# ------------------------------------------------------------------------------

# Syntax Error
query SyntaxError @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM restaurant")
}

# Missing Table
query MissingTable @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM MissingTable")
}

# Missing Column
query MissingCol @auth(level: NO_ACCESS) {
  _select(sql: "SELECT badCol FROM restaurant")
}

# Type Mismatch (DB Level)
query TypeMismatch @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM restaurant WHERE id = 'abc'")
}

# Div By Zero
query DivZero @auth(level: NO_ACCESS) {
  _select(sql: "SELECT 10/0")
}

# Param Count Mismatch
query ParamCountMismatch @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM restaurant WHERE id = $1 AND name = $2", params: [1])
}

# Param Type Mismatch (Client)
query ParamTypeMismatch($id: String) @auth(level: NO_ACCESS) {
  _select(sql: "SELECT * FROM restaurant WHERE id = $1", params: [$id])
}

# DML in Select
query DMLinSelect @auth(level: NO_ACCESS) {
  _select(sql: "DELETE FROM restaurant WHERE id=1")
}

# Oversized Response
query OversizedResponse @auth(level: NO_ACCESS) {
  _select(sql: "SELECT a.id, b.id FROM review a CROSS JOIN review b CROSS JOIN review c LIMIT 1000000000000000000000000000000000")
}
